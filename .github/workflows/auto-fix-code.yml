name: Auto Format and Lint Fix (Code)

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - '*.json'
      - '*.js'
      - '*.ts'
      - '*.tsx'
      - '*.jsx'
      - '*.md'
      - '*.css'
      - '*.scss'
      - '*.yaml'
      - '*.yml'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - 'next.config.*'
      - 'tailwind.config.*'
      - 'postcss.config.*'
      - 'eslint.config.*'

permissions:
  contents: write
  pull-requests: write

# åŒæ™‚å®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  autofix-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.16.0
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier (excluding workflows)
        run: |
          npx prettier --write . \
            --ignore-pattern ".github/workflows/**" \
            --ignore-pattern "node_modules/**" \
            --ignore-pattern ".next/**" \
            --ignore-pattern "out/**"

      - name: Run ESLint Fix (excluding workflows)
        run: |
          npx eslint . --fix \
            --ignore-pattern ".github/workflows/**" \
            --ignore-pattern "node_modules/**" \
            --ignore-pattern ".next/**" \
            --ignore-pattern "out/**"

      - name: Check for changes
        id: check_changes
        run: |
          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’é™¤å¤–ã—ã¦ç¢ºèª
          git add .
          git reset .github/workflows/ 2>/dev/null || true
          
          if [[ -n $(git diff --cached --name-only) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            git diff --cached --name-only
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ãƒªãƒ¢ãƒ¼ãƒˆã®æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—
          git fetch origin ${{ github.head_ref }}
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git commit -m "chore: è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»Lintä¿®æ­£ (ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«)

          ğŸ¤– GitHub Actionsã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£
          - Prettier ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          - ESLint ä¿®æ­£
          
          å¯¾è±¡: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ (.github/workflows/ é™¤å¤–)"
          
          # å®‰å…¨ã«ãƒ—ãƒƒã‚·ãƒ¥
          git push origin HEAD:${{ github.head_ref }}

      - name: Comment on PR if no changes
        if: steps.check_changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»Lintãƒã‚§ãƒƒã‚¯å®Œäº†ã€‚ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'
            })