name: Auto Format and Lint Fix

on:
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

# åŒæ™‚å®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  autofix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—
          ref: ${{ github.head_ref }}  # PRã®ãƒ–ãƒ©ãƒ³ãƒã‚’æ˜ç¤ºçš„ã«æŒ‡å®š

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.16.0
          cache: 'npm'  # npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier
        run: npm run format

      - name: Run ESLint Fix
        run: npm run lint:fix

      - name: Check if only workflow files changed
        id: check_files
        run: |
          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ä»¥å¤–ã«å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git status --porcelain | grep -v '\.github/workflows/'; then
            echo "has_non_workflow_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_non_workflow_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push if changes exist
        if: steps.check_files.outputs.has_non_workflow_changes == 'true'
        run: |
          git config --global user.name 'ci-bot'
          git config --global user.email 'ci-bot@example.com'
          
          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add . 
          git reset .github/workflows/
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«é™¤å¤–å¾Œï¼‰
          if [[ -n $(git diff --cached --name-only) ]]; then
            echo "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä»¥å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™..."
            
            # ãƒªãƒ¢ãƒ¼ãƒˆã®æœ€æ–°çŠ¶æ…‹ã‚’å–å¾—
            git fetch origin ${{ github.head_ref }}
            
            git commit -m "chore: è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»Lintä¿®æ­£"
            
            # ãƒªãƒ™ãƒ¼ã‚¹ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã«åˆã‚ã›ã‚‹
            git pull --rebase origin ${{ github.head_ref }} || {
              echo "ãƒªãƒ™ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è§£æ±ºã‚’è©¦ã¿ã¾ã™..."
              git rebase --abort
              git pull origin ${{ github.head_ref }}
              git add .
              git reset .github/workflows/
              git commit -m "chore: è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»Lintä¿®æ­£"
            }
            
            # ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆforce-with-leaseã§å®‰å…¨ã«ï¼‰
            git push --force-with-lease origin HEAD:${{ github.head_ref }}
          else
            echo "ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä»¥å¤–ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
          fi

      - name: Comment on PR if only workflow changes
        if: steps.check_files.outputs.has_non_workflow_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤– ãƒªãƒ³ã‚¿ãƒ¼ã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã«ã‚ˆã£ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ã®ãŸã‚ã€ã“ã‚Œã‚‰ã®å¤‰æ›´ã¯è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã§ãã¾ã›ã‚“ã€‚å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚'
            })